/** 
 * datatable v3.0.3
 * 
 * author : yonyou FED
 * homepage : https://github.com/iuap-design/datatable#readme
 * bugs : https://github.com/iuap-design/datatable/issues
 **/ 
u.TreeAdapter=u.BaseAdapter.extend({initialize:function(e){var t=e.options||{},a=e.model,i="string"==typeof e.el?document.querySelector(e.el):e.el;e.app;this.id=t.id,e=t;var d=this;this.dataTable=u.getJSObject(a,e.data),this.element=i,this.$element=$(i),this.id=e.id,this.element.id=this.id,this.options=e,this.events=$.extend(!0,{},e.events);var o={data:{simpleData:{enable:!0}},check:{chkboxType:{Y:"",N:""}},callback:{beforeClick:function(e,t,i){d.events.beforeClick&&u.getFunction(a,d.events.beforeClick)(e,t,i)},onCheck:function(e,t,a){for(var i=d.tree.getChangeCheckedNodes(),o=0;o<i.length;o++){var n=i[o].id,l=d.getRowIdByIdValue(n),r=d.dataTable.getIndexByRowId(l);i[o].checked?(i[o].checkedOld=!0,1==d.tree.setting.view.selectedMulti?d.dataTable.addRowsSelect([r]):d.dataTable.setRowSelect(r)):(i[o].checkedOld=!1,d.dataTable.setRowUnSelect(r))}},onClick:function(e,t,i){if($("#"+t+" li").removeClass("focusNode"),$("#"+t+" a").removeClass("focusNode"),$("#"+i.tId).addClass("focusNode"),$("#"+i.tId+"_a").addClass("focusNode"),1!=d.tree.setting.view.selectedMulti){var o=i.id,n=d.getRowIdByIdValue(o),l=d.dataTable.getIndexByRowId(n);d.dataTable.setRowSelect(l),d.events.onClick&&u.getFunction(a,d.events.onClick)(e,t,i)}}}},n={};this.options.setting&&(n=u.getJSObject(a,this.options.setting)||u.getJSObject(window,this.options.setting));var l=o.callback,r=n.callback;for(var s in l){var c=l[s],h=r&&r[s];if(h){var v=function(){c.apply(this,arguments),h.apply(this,arguments)};r[s]=v}}var p=$.extend(!0,{},o,n),f=[],g=this.dataTable.rows();if(g.length>0)if(this.options.codeTree){g.sort(function(e,t){var a=e.data,i=t.data,o=a[d.options.idField].value+"",n=i[d.options.idField].value+"";try{return o.localeCompare(n)}catch(l){return 0}});var b=new Array;$.each(g,function(){var e=this.data,t=e[d.options.idField].value;b.push(t)});var T="";$.each(g,function(){var e={},t=this.data,a=t[d.options.idField].value,i=t[d.options.nameField].value,o="",n=-1;if(""!=T)var n=a.indexOf(T);if(0==n)o=T;else for(var l=1;l<T.length;l++){var r=T.substr(0,l),s=a.indexOf(r);if(0!=s)break;var c=$.inArray(r,b);(c>0||0==c)&&(o=r)}e.id=a,e.pId=o,e.name=i,f.push(e),T=a})}else{new Array;$.each(g,function(){var e={},t=this.data,a=t[d.options.idField].value,i=t[d.options.pidField].value,o=t[d.options.nameField].value;e.id=a,e.pId=i,e.name=o,f.push(e)})}return this.tree=$.fn.zTree.init(this.$element,p,f),this.dataTable.on(u.DataTable.ON_ROW_SELECT,function(e){$.each(e.rowIds,function(){var e=d.dataTable.getRowByRowId(this),t=e.data,a=t[d.options.idField].value,i=d.tree.getNodeByParam("id",a);1!=d.tree.setting.view.selectedMulti||i.checked?d.tree.selectNode(i,!1):d.tree.checkNode(i,!0,!1,!0)})}),this.dataTable.on(u.DataTable.ON_ROW_UNSELECT,function(e){$.each(e.rowIds,function(){var e=d.dataTable.getRowByRowId(this),t=e.data,a=t[d.options.idField].value,i=d.tree.getNodeByParam("id",a);1==d.tree.setting.view.selectedMulti&&i.checked?d.tree.checkNode(i,!1,!0,!0):d.tree.cancelSelectedNode(i)})}),this.dataTable.on(u.DataTable.ON_INSERT,function(e){var t=[],a=[],i=!1;$.each(e.rows,function(){var e={},a=!1,o=this.data,n=o[d.options.idField].value,l=o[d.options.pidField].value,r=o[d.options.nameField].value;e.id=n,e.pId=l,e.name=r;var s=d.tree.getNodeByParam("pid",n),c=d.tree.getNodeByParam("id",l);s&&s.length>0&&(i=!0),c&&c.length>0&&(a=!0),!i&&a?d.tree.addNodes(c,e,!0):t.push(e)}),i||(a=d.tree.transformTozTreeNodes(t),d.tree.addNodes(null,a,!0))}),this.dataTable.on(u.DataTable.ON_DELETE,function(e){new Array;if(this.deleteRows.length>0)for(var t=0;t<this.deleteRows.length;t++){var a=this.deleteRows[t],i=a.data,o=i[d.options.idField].value,n=d.tree.getNodeByParam("id",o);d.tree.removeNode(n)}}),this.dataTable.on(u.DataTable.ON_DELETE_ALL,function(e){for(var t=d.tree.getNodes(),a=0,i=t.length;a<i;a++){var o=d.tree.getNodeByParam("id",t[a].id);d.tree.removeNode(o),a--,i=t.length}}),this.dataTable.on(u.DataTable.ON_LOAD,function(e){var e=d.dataTable.rows();if(e.length>0){new Array;$.each(e,function(){var e={},t=this.data,a=t[d.options.idField].value,i=t[d.options.pidField].value,o=t[d.options.nameField].value;e.id=a,e.pId=i,e.name=o,f.push(e)})}this.tree=$.fn.zTree.init(this.$element,p,f)}),this.dataTable.on(u.DataTable.ON_VALUE_CHANGE,function(e){var t=d.dataTable.getRowByRowId(e.rowId);if(t){var a=d.tree.getNodes(),i=t.getValue(d.options.idField),o=d.tree.getNodeByParam("id",i);!o&&a&&(o=a[a.length-1]);var n=e.field,l=e.newValue;if(d.options.idField==n&&o&&(o.id=l,d.tree.updateNode(o)),d.options.nameField==n&&o)o.name=l,d.tree.updateNode(o);else if(d.options.pidField==n){var r=d.tree.getNodeByParam("id",l);d.tree.moveNode(r,o,"inner")}}}),this.getRowIdByIdValue=function(e){var t=this,a=null;return $.each(this.dataTable.rows(),function(){var i=this.data,d=this.rowId;i[t.options.idField].value==e&&(a=d)}),a},this},getName:function(){return"tree"}}),u.compMgr.addDataAdapter({adapter:u.TreeAdapter,name:"tree"});